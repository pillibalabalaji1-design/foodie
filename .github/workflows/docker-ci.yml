name: Backend Docker CI + Helm GitOps

on:
  push:
    branches: [main]

permissions:
  contents: write

jobs:
  build-push-and-update-helm:
    runs-on: ubuntu-latest

    env:
      IMAGE_TAG: ${{ github.sha }}
      IMAGE_NAME: ${{ secrets.DOCKERHUB_USERNAME }}/foodie-backend
      HELM_REPO: https://github.com/pillibalabalaji1-design/foodie-helmchart.git
      HELM_BRANCH: main
      VALUES_FILE: values-foodie-app.yaml

    steps:
      - name: Checkout application repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push backend image
        uses: docker/build-push-action@v6
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}

      - name: Clone Helm repo and update image tags
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          set -euo pipefail

          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          git clone "https://x-access-token:${GH_TOKEN}@github.com/pillibalabalaji1-design/foodie-helmchart.git" helm-repo
          cd helm-repo
          git checkout "${HELM_BRANCH}"

          VALUES_PATH=""
          for candidate in "${VALUES_FILE}" "foodie/${VALUES_FILE}"; do
            if [ -f "${candidate}"; then
              VALUES_PATH="${candidate}"
              break
            fi
          done

          if [ -z "${VALUES_PATH}" ]; then
            echo "Unable to find ${VALUES_FILE} in Helm repo root or foodie/ directory."
            exit 1
          fi

          for service in frontend backend database; do
            sed -i -E "/^${service}:/,/^[^[:space:]]/ { /^  image:/,/^  [^[:space:]]/ { s#(^[[:space:]]*tag:[[:space:]]*).*$#\\1\"${IMAGE_TAG}\"#; } }" "${VALUES_PATH}"
          done

          if git diff --quiet -- "${VALUES_PATH}"; then
            echo "No changes detected in ${VALUES_PATH}; skipping commit and push."
            exit 0
          fi

          git add "${VALUES_PATH}"
          git commit -m "chore(helm): update frontend/backend/database image tags to ${IMAGE_TAG}"
          git push origin "${HELM_BRANCH}"
